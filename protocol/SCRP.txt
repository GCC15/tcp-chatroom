This is the specification of the Stupid Chat Room Protocol (SCRP), a lightweight
application-layer communication protocol used in the project tcp-chatroom
(https://github.com/GCC15/tcp-chatroom). The SCRP is designed to work together
with other protocols including TLS/TCP/IP, although it is completely independent
of the underlying protocols.

Author:
Zhang NS (https://github.com/zhangns)
Zifan Li (https://github.com/LiZifan)
Zichao Li (https://github.com/kenathe)
All Rights Reserved.

Version: 0.0.3
Revision: 3 Sep 2015

Status: Under development


1. Concepts

  This section defines abstract entities and the fields needed to describe the
  state and properties of each of them. The name, the data type, the meaning,
  and the definition of validity of each field are specified.

  1.1 SCRP system

    An SCRP system consists of a server and some clients.

  1.2 Server

    The server is a computer program which handles requests from clients.

    Nickname (Unicode string)

      A human-readable name of the server, e.g. "My Awesome Server". length <=
      32.

    Version (ASCII string)

      The version of the server, e.g. "1.0.0". length <= 16.

    Description (Unicode string)

      The description of the server. length <= 256.

    Protocol version (ASCII string)

      The version of SCRP followed by the server, e.g. "1.0.0". length <= 16.

    Time (uint32)

      The current timestamp as seen from the server.

    Uptime (uint32)

      The timestamp when the server started running.

    Number of users (uint32)

      Number of currently registered users.

    Max number of users (uint32)

      The maximum number of registered users since the server started.

    Number of online users (uint32)

      Number of registered users currently online.

    Max number of online users (uint32)

      The maximum number of online users since the server started.

    Number of rooms (uint32)

      Number of registered rooms.

    Max number of rooms (uint32)

      The maximum number of rooms since the server started.

    Messages in (uint32)

      Number of messages received since the server started.

    Messages out (uint32)

      Number of messages sent since the server started.

    Data in (uint64)

      Amount of raw data received in bytes since the server started. The
      interpretation of "raw data" is implementation-dependent.

    Data out (uint64)

      Amount of raw data sent in bytes since the server started. The
      interpretation of "raw data" is implementation-dependent.

  1.3 Client

    A client is a computer program which communicates with the server on behalf
    of a user. Clients include but are not limited to general-purpose GUI
    applications and automated scripts.

    Nickname (Unicode string)

      A human-readable name of the client, e.g. "My Awesome Client". length <=
      32.

    Version (ASCII string)

      The version of the client, e.g. "1.0.0". length <= 16.

    Description (Unicode string)

      The description of the client. length <= 256.

    Protocol version (ASCII string)

      The version of SCRP followed by the client, e.g. "1.0.0". length <= 16.

    Time (uint32)

      The current timestamp as seen from the client.

  1.4 User

    A user chats (a) with its friends, and (b) in rooms.

    ID (ASCII string)

      The identifier of the user, e.g. "john_42". It is valid if and only if (a)
      1 <= length <= 16, (b) it only contains alphanumeric characters
      (case-sensitive) and/or underscore(s), and (c) it is unique.

    Password (ASCII string)

      The login credential of the user, e.g. "my_very_secure_password". It is
      valid if and only if (a) 6 <= length <= 64, and (b) it only contains
      printable ASCII characters, i.e. ASCII code 32 - 126 (0x20 - 0x7E).

    Nickname (Unicode string)

      A human-readable name of the user, e.g. "Erwin SchrÃ¶dinger". 1 <= length
      <= 32.

    Description (Unicode string)

      The description of the user. length <= 256.

    Sign up time (uint32)

      The server time when the user signed up on the server.

    Last activity time (uint32)

      The server time of the last time the user logged off from the server.

    Friends (collection of user)

      Each user has zero or more friends.

    Rooms (collection of room)

      Each user belongs to zero or more rooms.

    Mode (enum int)
    The mode determines condition of the user.
      There are currently 2 modes.

      OFF = 0

        User is logged off.

      ON = 1

        User is logged in.
    
  1.5 Room

    A room consists of one or more users. Users send messages in the room.

    ID (ASCII string)

      The identifier of the room. It is valid if and only if (a) 1 <= length <=
      16, (b) it only contains alphanumeric characters (case-sensitive) and/or
      underscore(s), and (c) it is unique.

    Nickname (Unicode string)

      A human-readable name of the room. 1 <= length <= 32.

    Description (Unicode string)

      The description of the room. length <= 256.

    Creator (user)

      The user who owns the room. The room creator has the greatest power in the
      room. Each room must have one creator.

    Admins (collection of user)

      An admin administrates the room. Room admins are appointed by the room
      creator. Room admins have more power than general users but less power
      than the room creator. A room has zero or more admins.

    Password (ASCII string)

      The room password can be optionally set to prevent undesired users from
      entering the room. It is valid if and only if (a) 6 <= length <= 64,
      and (b) it only contains printable ASCII characters, i.e. ASCII code 32 -
      126 (0x20 - 0x7E).

    Access type (enum int)

      The access type determines the condition for users to enter the room.
      There are 3 access types.

      ROOM_ACCESS_PUBLIC = 0

        Any user can enter the room unconditionally.

      ROOM_ACCESS_PASSWORD = 1

        A user can enter the room if and only if the correct password is
        presented.

      ROOM_ACCESS_PERMISSION = 2

        A user can enter the room with the permission of the creator or any
        admin in the room.

  1.6 Room message

    Room messages are what users send in a room. All other users in the same
    room at the time the message was sent can see the message.

    ID (uint32)

      The identifier of the message. It is unique among all messages.

    Time (uint32)

      The server time when the message was received by the server.

    Sender (user)

      The user who sent the message.

    Target room (room)

      The room in which the message was sent.

  1.7 Private message

    A private message is what a user sends to one of its friends. Only the
    specific receiver can see the message.

    ID (uint32)

      The identifier of the message. It is unique among all messages.

    Time (uint32)

      The server time when the message was received by the server.

    Sender (user)

      The user who sent the message.

    Receiver (user)

      The user to whom the message was sent.


2. Request & Response

  Requests are what a client sends to the server. A request is represented by a
  JSON dictionary which contains the following fields.

    (a) req_id (uint32)

      The serial number of the request. It is unique among all requests from the
      same client in the same session:

    (b) method (string)

      The method name of the request (case-sensitive).

    (c) Other fields dependent on the method.

  The server must sends a response to each request from a client. A response 
  is represented by a JSON dictionary which contains the following fields.

    (a) resp_id (uint32)

      The req_id of the request that the server is responding to.

    (b) Other fields dependent on the request method, including an error field,
        which represents the error type of the response, defined in Section 3.

  All SCRP request methods are defined below. For each method, the name, the
  JSON data type, and the meaning of each request field and each response field
  are specified. The algorithm for the server to process each request is also
  specified.

  2.1 SIGN_UP

    Sign up a new user.

    Request fields

      user_id (string)

        The ID of the new user.

      user_password (string)

        The password of the new user.

      user_nickname (string)

        The nickname of the new user.

      TODO: Fields for others.

    Response fields

      err (number)

        300 INVALID_USER_ID

        310 INVALID_USER_PASSWORD

        320 INVALID_USER_NICKNAME

        400 USER_ALREADY_EXISTS

        900 SUCCESS

    Algorithm

      (1) If user ID is invalid, return 300;

      (2) If user password is invalid, return 310;

      (3) If user nickname is invalid, return 320;

      (4) If a user with the same user ID is found, return 400;

      (5) TODO: Elaborate

      (6) Return 900;

  2.2 LOG_IN

    Log in as an existing user.

    Request fields

      user_id (string)

        The user ID.

      user_password (string)

        The user password.

    Response fields

      err (number)

        300 INVALID_USER_ID

        310 INVALID_USER_PASSWORD

        402 TOO_MANY_WRONG_ATTEMPTS

        403 ID_PASSWORD_NOT_MATCH

        404 USER_ALREADY_LOGGED_IN

        900 SUCCESS

    Algorithm

      (1) If user ID is invalid, return 300;

      (2) If user password is invalid, return 310;

      (3) If a user with the same user ID is found, return 400;

      (4) If there are too many wrong attempts,  return 402;

      (5) If the user ID and password do not match, return 403;

      (5) If the user is already logged in, return 404;

      (6) TODO: Elaborate;

      (7) Return 900;

  2.3 DELETE_USER

    Delete the current user permanently.

    This request can only be sent from a client with a user that is logged in.

    Request fields

      user_id (string)

        The user ID.

      user_password (string)

        The user password.

    Response fields

      err (number)

        250 USER_NOT_LOGGED_IN

        310 INVALID_USER_PASSWORD

        402 TOO_MANY_WRONG_ATTEMPTS

        403 ID_PASSWORD_NOT_MATCH

        900 SUCCESS

    Algorithm

      (1) If the user is not logged in, return 250;

      (2) If user password is not valid, return 310;

      (3) If there are too many wrong attempts,  return 402;

      (4) If the user ID and password do not match, return 403;

      (5) TODO: Elaborate;

      (6) Return 900;

  2.4 CHANGE_USER_PASSWORD

    Change the user password.

    This request can only be sent from a client with a user that is logged in.

    Request fields

      user_id (string)
        The user ID.

      old_user_password (string)

        The current password.

      new_user_password (string)

        The new password.

    Response fields

      err (number)

        250 USER_NOT_LOGGED_IN 

        310 INVALID_USER_PASSWORD

        402 TOO_MANY_WRONG_ATTEMPTS

        403 ID_PASSWORD_NOT_MATCH

        900 SUCCESS

    Algorithm

      (1) If the user is not logged in, return 250;

      (2) If old user password or new user password is not valid, return 310;

      (3) If there are too many wrong attempts,  return 402;

      (4) If the user ID and password do not match, return 403;

      (5) TODO: Elaborate;

      (6) Return 900;

  2.5 CHANGE_USER_NICKNAME

    Change the user nickname.

    This request can only be sent from a client with a user that is logged in.

    Request fields

      user_id (string)
        The user ID.

      old_user_nickname (string)

        The current nickname.

      new_user_nickname (string)

        The new nickname.

    Response fields

      err (number)

        250 USER_NOT_LOGGED_IN 

        320 INVALID_USER_NICKNAME

        900 SUCCESS

    Algorithm

      (1) If the user is not logged in, return 250;

      (2) If old user nickname or new user nickname is not valid, return 320;

      (3) TODO: Elaborate;

      (4) Return 900;

  2.6 GET_TIME

    Get the server time when the request is received by the server. This method
    can be used to estimate the network latency.

    Request fields

      (None)

    Response fields

      time (number)

      err (number)

        900 SUCCESS

    Algorithm

      (1) Return sever time with error code 900;

  2.7 CREATE_ROOM

    Create a new room.

    This request can only be sent from a client with a user that is logged in.

    Request fields

      room_id (string)

        The room ID.

      room_nickname (string)

        The room nickname.

      user_id (string)

        The user ID.

      room_access (enum int)

        The access type of the room.

      room_password (string)

        The room password [optional]

    Response fields

      err (number)

        250 USER_NOT_LOGGED_IN 

        301 INVALID_ROOM_ID

        311 INVALID_ROOM_PASSWORD

        321 INVALID_ROOM_NICKNAME

        401 ROOM_ALREADY_EXISTS

        900 SUCCESS

    Algorithm

      (1) If the user is not logged in, return 250;

      (2) If room ID is invalid, return 301;

      (3) If room password is invalid, return 311;

      (4) If room nickname is invalid, return 321;

      (5) If a room with the same room ID is found, return 401;      

      (6) TODO: Elaborate;

      (7) Return 900;

  2.8 ENTER_ROOM

    Enter an existed room.

    This request can only be sent from a client with a user that is logged in.

    Request fields

      room_id (string)

        The room ID.

      user_id (string)

        The user ID.

      room_password (string)

        The room password [optional]

    Response fields

      err (number)

        250 USER_NOT_LOGGED_IN 

        301 INVALID_ROOM_ID

        311 INVALID_ROOM_PASSWORD

        401 ROOM_ALREADY_EXISTS

        402 TOO_MANY_WRONG_ATTEMPTS

        403 ID_PASSWORD_NOT_MATCH

        900 SUCCESS

    Algorithm

      (1) If the user is not logged in, return 250;

      (2) If room ID is invalid, return 301;

      (3) If room password is invalid, return 311;

      (5) If there are too many wrong attempts,  return 402;

      (6) If the room ID and password do not match, return 403;      

      (7) TODO: Elaborate;

      (8) Return 900;

  2.9 REMOVE_ROOM

    Remove an existed room permanently.

    This request can only be sent from the owner of the room who must be logged in.

    Request fields

      user_id (string)

        The user ID.

      room_id (string)

        The room ID.

    Response fields

      err (number)

        250 USER_NOT_LOGGED_IN

        300 INVALID_USER_ID

        301 INVALID_ROOM_ID

        801 FORBIDDEN

        900 SUCCESS

    Algorithm

      (1) If the user is not logged in, return 250;

      (2) If user id is not valid, return 300;

      (3) If the room id is not valid, return 301;

      (4) If the user is not authorized to send the request, return 801;

      (5) TODO: Elaborate;

      (6) Return 900;

  2.10 CHANGE_ROOM_ACCESS

    Change the access type of a room.

    This request can only be sent from the owner of the room who must be logged in.

    Request fields

      user_id (string)

        The user ID.

      room_id (string)

        The room ID.

      new_access_type (number)

        The access type that is supposed to change to.

      room_password (string)

        The room password. Needed only when the access_type is ROOM_ACCESS_PASSWORD.

    Response fields

      err (number)

        250 USER_NOT_LOGGED_IN

        300 INVALID_USER_ID

        301 INVALID_ROOM_ID

        311 INVALID_ROOM_PASSWORD

        801 FORBIDDEN

        900 SUCCESS

    Algorithm

      (1) If the user is not logged in, return 250;

      (2) If user id is not valid, return 300;

      (3) If the room id is not valid, return 301;

      (4) If room password is not valid, return 311;

      (5) If the user is not authorized to send the request, return 801;

      (6) TODO: Elaborate;

      (7) Return 900;

  2.11 CHANGE_ROOM_PASSWORD

    Change the password of a room.

    This request can only be sent from the owner of the room who must be logged in.

    This request can only be performed on a room with access type of ROOM_ACCESS_PASSWORD.

    Request fields

      user_id (string)

        The user ID.

      room_id (string)

        The room ID.

      old_room_password (string)

        The current room password. 

      new_room_password (string)

        The new room password. 

    Response fields

      err (number)

        250 USER_NOT_LOGGED_IN

        300 INVALID_USER_ID

        301 INVALID_ROOM_ID

        311 INVALID_ROOM_PASSWORD

        402 TOO_MANY_WRONG_ATTEMPTS

        403 ID_PASSWORD_NOT_MATCH

        801 FORBIDDEN

        900 SUCCESS

    Algorithm

      (1) If the user is not logged in, return 250;

      (2) If user ID is not valid, return 300;

      (3) If room ID is not valid, return 301;

      (4) If room password is not valid, return 311;

      (5) If there are too many wrong attemps, return 402;

      (6) If the room ID and password do not match, return 403;

      (7) If the user is not authorized to send the request, return 801;

      (8) TODO: Elaborate;

      (9) Return 900;

  2.12 CHANGE_ROOM_NICKNAME

    Change the nickname of a room.

    This request can only be sent from the admins of the room who must be logged in.

    Request fields

      user_id (string)

        The user ID.

      room_id (string)

        The room ID.

      new_room_nickname (string)

        The new room nickname. 

    Response fields

      err (number)

        250 USER_NOT_LOGGED_IN

        300 INVALID_USER_ID

        301 INVALID_ROOM_ID

        321 INVALID_ROOM_NICKNAME

        801 FORBIDDEN

        900 SUCCESS

    Algorithm

      (1) If the user is not logged in, return 250;

      (2) If user ID is not valid, return 300;

      (3) If room ID is not valid, return 301;

      (4) If the new room nickname is not valid, return 321;

      (5) If the user is not authorized to send the request, return 801;

      (6) TODO: Elaborate;

      (7) Return 900;

  2.12 REMOVE_USER_FROM_ROOM

    Remove a user from the room.

    This request can only be sent from the admins of the room who must be logged in.
    The admins can not remove each other or the owner from the room. 
    The owner can remove anyone else from the room, including admins.

    Request fields

      admin_user_id (string)

        The user ID of the admin (request sender).

      subject_user_id (string)

        The user ID of the subject (the user who is going to be removed).

      room_id (string)

        The room ID.

    Response fields

      err (number)

        250 USER_NOT_LOGGED_IN

        300 INVALID_USER_ID

        301 INVALID_ROOM_ID

        801 FORBIDDEN

        900 SUCCESS

    Algorithm

      (1) If the user is not logged in, return 250;

      (2) If the ID of the admin or the ID of the subject is not valid, return 300;

      (3) If room ID is not valid, return 301;

      (4) If the user is not authorized to send the request, return 801;

      (5) TODO: Elaborate;

      (6) Return 900;


  2.13 SET_ADMIN

  Set an admin for the room.

    This request can only be sent from the owner of the room who must be logged in.

    Request fields

      owner_user_id (string)

        The user ID of the owner (request sender).

      subject_user_id (string)

        The user ID of the subject (the user who is going to be set as an admin).

      room_id (string)

        The room ID.

    Response fields

      err (number)

        250 USER_NOT_LOGGED_IN

        300 INVALID_USER_ID

        301 INVALID_ROOM_ID

        801 FORBIDDEN

        900 SUCCESS

    Algorithm

      (1) If the user is not logged in, return 250;

      (2) If the ID of the owner or the ID of the subject is not valid, return 300;

      (3) If room ID is not valid, return 301;

      (4) If the user is not authorized to send the request, return 801;

      (5) TODO: Elaborate; what if too many admin?

      (6) Return 900;

  2.14 REMOVE_ADMIN

  2.15 ADD_FRIEND

  2.16 REMOVE_FRIEND

  2.17 CHANGE_USER_DESCRIPTION

  2.18 CHANGE_ROOM_DESCRIPTION

  2.19 GET_USER_LAST_ACTIVITY_TIME (?)

  2.20 ADD_FRIEND

  2.21 REMOVE_FRIEND

  2.22 APPROVE_REQUEST (like add friend or join room)

  2.23 IGNORE_REQUEST

  2.24 REJECT_REQUEST

  2.26 SEND_ROOM_MESSAGE

  2.27 SEND_PRIVATE_MESSAGE

  2.28 RECEIVE_MESSAGE (when an user logged in and want to see the message that is sent 
  during his logged off period)

  
3. Error
  
  Error is an indispensible part of the reponse to the requests sent from clients to server.

  Each type of error has an error number, a name, and a description.

  Note: The algorithms specified in Section 2 and the error numbers in this
  section are designed so that when the requirements of multiple errors are met
  simultaneously, the server must respond with the error with the smallest error
  number. This suggests that the server should usually check for errors in
  ascending order of error numbers, whenever necessary.

  233 BAD_REQUEST

    The request is not understood because it violates the SCRP specification
    (the version followed by the server) to a large extent, and is thus
    ignored.

  250 USER_NOT_LOGGED_IN

    The server refuses to process the request because the client is not logged in
    before sending the request.

  300 INVALID_USER_ID

    The format of the user ID is invalid.

  301 INVALID_ROOM_ID

    The format of the room ID is invalid.

  310 INVALID_USER_PASSWORD

    The format of the user password is invalid.

  311 INVALID_ROOM_PASSWORD

    The format of the room password is invalid.

  320 INALID_USER_NICKNAME

    The format of the user nickname is invalid.

  321 INVALID_ROOM_NICKNAME

    The format of the room nickname is invalid.

  TODO: Other 3xx invalid errors. descriptions, nickname, etc...

  Note: Errors with error number smaller than 400 never occurs if the client
  follows this specification.

  400 USER_ALREADY_EXISTS

    The user ID already exists.

  401 ROOM_ALREADY_EXISTS

    The Room ID already exists.

  402 TOO_MANY_WRONG_ATTEMPTS

    Wrong attempts are too often.

  403 ID_PASSWORD_NOT_MATCH

    The ID and the password do not match.

  404 USER_ALREADY_LOGGED_IN

    The user is already logged in.

  TODO: Other errors

  801 FORBIDDEN

    The sender of the request is not authorized to perform the requested action.

  900 SUCCESS

    The requested action was performed without errors.

  999 UNKNOWN

    An unexpected error occurred.

    Note: This error never occurs if the server is properly developed following
    this specification. The client can assume that this error never occurs.

4. Server push

  Server pushes are messages that the server sends to cients from time to time.
  A server push is analogous to a request, but different in a major way that 
  a server push does not need a response.

  4.1 NEW_PRIVATE_MESSAGE

  4.2 NEW_ROOM_MESSAGE

  4.3 NEW_FRIEND_REQUEST

  4.4 ENTER_ROOOM_REQUEST

  4.5 USER_LEAVE_ROOM

  4.6 APPOINTED_AS_ADMIN

  4.7 FORCED_TO_LOGGED_OFF (?)
